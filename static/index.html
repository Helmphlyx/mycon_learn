<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyCon Learn - Vietnamese Practice</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        [v-cloak] { display: none; }
        .shake {
            animation: shake 0.5s ease-in-out;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app" v-cloak class="container mx-auto px-4 py-8 max-w-5xl">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">MyCon Learn</h1>
            <p class="text-gray-600">Vietnamese Practice App</p>
        </header>

        <div class="flex gap-6">
            <!-- Main Content Area -->
            <div class="flex-1 min-w-0">
                <!-- Stats Bar -->
                <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <div class="flex gap-4 items-center">
                            <span class="text-blue-600 font-bold text-lg">{{ masteredCount }}/{{ topicTotalCards }}</span>
                            <span class="text-gray-400">|</span>
                            <span class="text-green-600 font-medium">{{ masteredCount }} mastered</span>
                            <span class="text-gray-500 font-medium">{{ wordPool.length }} remaining</span>
                        </div>
                        <div class="flex gap-2">
                            <button
                                @click="setMode('eng_to_viet')"
                                :class="mode === 'eng_to_viet' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'"
                                class="px-3 py-1 rounded text-sm font-medium transition"
                            >
                                Eng → Viet
                            </button>
                            <button
                                @click="setMode('viet_to_eng')"
                                :class="mode === 'viet_to_eng' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'"
                                class="px-3 py-1 rounded text-sm font-medium transition"
                            >
                                Viet → Eng
                            </button>
                        </div>
                    </div>

                    <!-- Show Answers Toggle & Topic Selector -->
                    <div class="flex items-center gap-4 pt-3 border-t border-gray-200">
                        <label class="flex items-center gap-2 cursor-pointer select-none flex-shrink-0">
                            <span class="text-sm text-gray-600 font-medium">Show Answers</span>
                            <div class="relative" @click="toggleShowAnswers">
                                <div :class="showAnswersMode ? 'bg-yellow-500' : 'bg-gray-300'" class="w-10 h-5 rounded-full transition-colors"></div>
                                <div :class="showAnswersMode ? 'translate-x-5' : 'translate-x-0'" class="absolute top-0.5 left-0.5 w-4 h-4 bg-white rounded-full shadow transition-transform"></div>
                            </div>
                        </label>
                    </div>

                    <!-- Topic/Category Selector -->
                    <div class="flex items-center gap-3 pt-3 border-t border-gray-200">
                        <label class="text-sm text-gray-600 font-medium">Topic:</label>
                        <select
                            v-model="selectedCategory"
                            @change="onCategoryChange"
                            class="flex-1 px-3 py-1.5 border border-gray-300 rounded text-sm focus:border-blue-500 focus:outline-none"
                        >
                            <option value="">All Topics</option>
                            <option v-for="cat in categories" :key="cat" :value="cat">{{ cat }}</option>
                        </select>
                        <button
                            @click="resetTopicMastery"
                            class="text-orange-600 hover:text-orange-700 p-1"
                            title="Reset Topic Mastery"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <button
                            @click="showTopicManager = !showTopicManager"
                            class="text-gray-500 hover:text-blue-600 p-1"
                            title="Manage Topics"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Topic Manager Panel -->
                <div v-if="showTopicManager" class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold">Manage Topics</h3>
                        <button @click="showTopicManager = false" class="text-gray-400 hover:text-gray-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>

                    <!-- Available CSV Files -->
                    <div class="mb-4">
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Available CSV Files (vocab/ folder)</h4>
                        <div v-if="availableTopics.length === 0" class="text-sm text-gray-500 italic">
                            No CSV files found. Add .csv files to the vocab/ folder.
                        </div>
                        <div v-else class="space-y-2">
                            <div
                                v-for="topic in availableTopics"
                                :key="topic.filename"
                                class="flex items-center justify-between p-2 bg-gray-50 rounded"
                            >
                                <span class="text-sm">{{ topic.name }}</span>
                                <button
                                    @click="loadTopic(topic.filename, false)"
                                    :disabled="loadingTopic === topic.filename"
                                    class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200 disabled:opacity-50"
                                >
                                    {{ loadingTopic === topic.filename ? 'Loading...' : 'Load' }}
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Sync All Button -->
                    <div class="flex gap-2">
                        <button
                            @click="syncAllTopics"
                            :disabled="syncing"
                            class="flex-1 bg-green-600 text-white py-2 rounded text-sm font-medium hover:bg-green-700 disabled:opacity-50"
                        >
                            {{ syncing ? 'Syncing...' : 'Sync All CSV Files' }}
                        </button>
                        <button
                            @click="refreshCategories"
                            class="bg-gray-200 text-gray-700 px-4 py-2 rounded text-sm font-medium hover:bg-gray-300"
                        >
                            Refresh
                        </button>
                    </div>

                    <!-- Status Message -->
                    <div v-if="topicMessage" class="mt-3 text-sm p-2 rounded" :class="topicMessageType === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
                        {{ topicMessage }}
                    </div>

                    <!-- CSV Format Help -->
                    <div class="mt-4 p-3 bg-gray-50 rounded text-xs text-gray-600">
                        <p class="font-medium mb-1">CSV Format:</p>
                        <code class="block bg-gray-200 p-2 rounded">vietnamese,english<br>xin chào,hello<br>tạm biệt,goodbye</code>
                    </div>
                </div>

                <!-- No Cards Message -->
                <div v-if="noCards" class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center">
                    <p class="text-yellow-800 mb-4">
                        {{ selectedCategory ? `No cards in "${selectedCategory}" topic.` : 'No flashcards available.' }}
                    </p>
                    <div class="flex gap-2 justify-center">
                        <button v-if="selectedCategory" @click="selectedCategory = ''; loadTopicCards()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300">
                            Show All Topics
                        </button>
                        <button @click="showTopicManager = true" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                            Load from CSV
                        </button>
                        <button @click="showAddCard = true" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                            Add Card Manually
                        </button>
                    </div>
                </div>

                <!-- Topic Complete Message -->
                <div v-else-if="topicComplete" class="bg-green-50 border border-green-200 rounded-xl shadow-lg p-8 mb-6 text-center">
                    <h2 class="text-2xl font-bold text-green-800 mb-2">Topic Complete!</h2>
                    <p class="text-green-700 mb-4">You've mastered all {{ topicTotalCards }} words in this topic.</p>
                    <div class="flex gap-3 justify-center">
                        <button
                            @click="resetTopicMastery"
                            class="bg-orange-500 text-white px-6 py-3 rounded-lg font-medium hover:bg-orange-600 transition"
                        >
                            Reset & Practice Again
                        </button>
                    </div>
                </div>

                <!-- Quiz Card -->
                <div v-else class="bg-white rounded-xl shadow-lg p-8 mb-6">
                    <!-- Category Badge -->
                    <div v-if="currentCard?.category" class="text-center mb-2">
                        <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">{{ currentCard.category }}</span>
                    </div>

                    <!-- Result Banner -->
                    <div
                        v-if="feedbackMessage"
                        :class="feedbackType === 'success' ? 'bg-green-100 border-green-500 text-green-800' :
                                feedbackType === 'error' ? 'bg-red-100 border-red-500 text-red-800' :
                                'bg-yellow-100 border-yellow-500 text-yellow-800'"
                        class="border-l-4 p-4 mb-6 rounded"
                    >
                        <p class="font-bold">{{ feedbackMessage }}</p>
                        <p v-if="expectedAnswer" class="mt-1">
                            Answer: <span class="font-mono font-bold">{{ expectedAnswer }}</span>
                        </p>
                        <p v-if="attempts > 0 && !cardCompleted" class="text-sm mt-1">
                            Attempts: {{ attempts }}
                        </p>
                    </div>

                    <!-- Prompt Display -->
                    <div class="text-center mb-8">
                        <p class="text-gray-500 text-sm mb-2">
                            {{ mode === 'eng_to_viet' ? 'Translate to Vietnamese:' : 'Translate to English:' }}
                        </p>
                        <h2 class="text-4xl font-bold text-gray-800">{{ currentCard?.prompt || '...' }}</h2>
                    </div>

                    <!-- Hint Display -->
                    <div v-if="currentHint" class="text-center mb-4 text-gray-600 font-mono text-xl">
                        Hint: {{ currentHint }}
                    </div>

                    <!-- Input Form -->
                    <form @submit.prevent="submitAnswer" class="space-y-4">
                        <input
                            ref="answerInput"
                            v-model="userAnswer"
                            type="text"
                            :placeholder="mode === 'eng_to_viet' ? 'Type in Vietnamese...' : 'Type in English...'"
                            class="w-full px-4 py-3 text-xl border-2 rounded-lg focus:outline-none text-center transition-colors"
                            :class="inputClass"
                            :disabled="cardCompleted"
                            autocomplete="off"
                            spellcheck="false"
                        >

                        <div class="flex gap-3 justify-center flex-wrap">
                            <!-- Check Answer Button (when card not completed) -->
                            <button
                                v-if="!cardCompleted"
                                type="submit"
                                class="bg-blue-600 text-white px-8 py-3 rounded-lg font-medium hover:bg-blue-700 transition"
                            >
                                Check Answer
                            </button>

                            <!-- Hint Button (when card not completed) -->
                            <button
                                v-if="!cardCompleted"
                                type="button"
                                @click="getHint"
                                class="bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-medium hover:bg-gray-300 transition"
                            >
                                Hint ({{ hintLevel }}/3)
                            </button>

                            <!-- Give Up Button (when card not completed and has attempts) -->
                            <button
                                v-if="!cardCompleted && attempts > 0"
                                type="button"
                                @click="giveUp"
                                class="bg-red-100 text-red-700 px-6 py-3 rounded-lg font-medium hover:bg-red-200 transition"
                            >
                                Give Up
                            </button>

                            <!-- Next Card Button (when card completed) -->
                            <button
                                v-if="cardCompleted"
                                type="button"
                                @click="nextCard"
                                class="bg-blue-600 text-white px-8 py-3 rounded-lg font-medium hover:bg-blue-700 transition"
                            >
                                Next Card
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Add Card Button -->
                <div class="text-center">
                    <button
                        @click="showAddCard = !showAddCard"
                        class="text-blue-600 hover:text-blue-800 font-medium"
                    >
                        {{ showAddCard ? 'Cancel' : '+ Add New Card' }}
                    </button>
                </div>

                <!-- Add Card Form -->
                <div v-if="showAddCard" class="bg-white rounded-xl shadow-lg p-6 mt-4">
                    <h3 class="text-lg font-bold mb-4">Add New Card</h3>
                    <form @submit.prevent="addCard" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Vietnamese</label>
                            <input
                                v-model="newCard.vietnamese"
                                type="text"
                                class="w-full px-3 py-2 border border-gray-300 rounded focus:border-blue-500 focus:outline-none"
                                required
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">English</label>
                            <input
                                v-model="newCard.english"
                                type="text"
                                class="w-full px-3 py-2 border border-gray-300 rounded focus:border-blue-500 focus:outline-none"
                                required
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                            <input
                                v-model="newCard.category"
                                type="text"
                                list="category-list"
                                class="w-full px-3 py-2 border border-gray-300 rounded focus:border-blue-500 focus:outline-none"
                                placeholder="e.g., greetings, food, verbs"
                            >
                            <datalist id="category-list">
                                <option v-for="cat in categories" :key="cat" :value="cat"></option>
                            </datalist>
                        </div>
                        <button
                            type="submit"
                            class="w-full bg-green-600 text-white py-2 rounded font-medium hover:bg-green-700 transition"
                        >
                            Add Card
                        </button>
                    </form>
                </div>

                <!-- Keyboard Tips -->
                <div class="mt-8 text-center text-sm text-gray-500">
                    <p>Tip: Use Vietnamese Telex keyboard for diacritics (e.g., type "ngayf" for "ngay")</p>
                </div>
            </div>

            <!-- Sidebar: Practiced Words -->
            <div class="w-72 flex-shrink-0">
                <div class="bg-white rounded-xl shadow-lg p-4 sticky top-4">
                    <h3 class="text-lg font-bold mb-3 text-gray-800">Progress</h3>

                    <!-- Progress Bar -->
                    <div class="mb-4">
                        <div class="flex justify-between text-sm text-gray-600 mb-1">
                            <span>{{ masteredCount }} of {{ topicTotalCards }} mastered</span>
                            <span>{{ topicTotalCards > 0 ? Math.round((masteredCount / topicTotalCards) * 100) : 0 }}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div
                                class="bg-blue-600 h-2 rounded-full transition-all duration-300"
                                :style="{ width: topicTotalCards > 0 ? (masteredCount / topicTotalCards * 100) + '%' : '0%' }"
                            ></div>
                        </div>
                    </div>

                    <!-- Practiced Words List -->
                    <div class="border-t border-gray-200 pt-3">
                        <h4 class="text-sm font-medium text-gray-600 mb-2">Practiced Words</h4>
                        <div v-if="practicedWords.length === 0" class="text-sm text-gray-400 italic">
                            No words practiced yet
                        </div>
                        <div v-else class="space-y-2 max-h-96 overflow-y-auto">
                            <div
                                v-for="word in practicedWords"
                                :key="word.id"
                                class="flex items-center gap-2 p-2 rounded text-sm"
                                :class="word.mastered ? 'bg-green-50' : 'bg-red-50'"
                            >
                                <span
                                    class="w-5 h-5 flex items-center justify-center rounded-full text-white text-xs flex-shrink-0"
                                    :class="word.mastered ? 'bg-green-500' : 'bg-red-500'"
                                >
                                    {{ word.mastered ? '✓' : '✗' }}
                                </span>
                                <div class="min-w-0 flex-1">
                                    <div class="font-medium text-gray-800 truncate">{{ word.vietnamese }}</div>
                                    <div class="text-gray-500 text-xs truncate">{{ word.english }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, computed, onMounted, onUnmounted, nextTick } = Vue;

        createApp({
            setup() {
                const mode = ref('eng_to_viet');
                const currentCard = ref(null);
                const currentCardFull = ref(null);
                const userAnswer = ref('');
                const expectedAnswer = ref('');
                const currentHint = ref('');
                const hintLevel = ref(0);
                const hintsUsedThisCard = ref(0);
                const showAddCard = ref(false);
                const noCards = ref(false);
                const answerInput = ref(null);

                // Feedback state
                const feedbackMessage = ref('');
                const feedbackType = ref(''); // 'success', 'error', 'warning'
                const attempts = ref(0);
                const cardCompleted = ref(false);
                const lastWasWrong = ref(false);

                // Topic management
                const selectedCategory = ref('');
                const categories = ref([]);
                const availableTopics = ref([]);
                const showTopicManager = ref(false);
                const loadingTopic = ref(null);
                const syncing = ref(false);
                const topicMessage = ref('');
                const topicMessageType = ref('success');

                // Word pool and progress tracking
                const allTopicCards = ref([]);
                const wordPool = ref([]);
                const topicTotalCards = ref(0);
                const practicedWords = ref([]);
                const topicComplete = ref(false);
                const showAnswersMode = ref(false);

                const newCard = reactive({
                    vietnamese: '',
                    english: '',
                    category: '',
                });

                const masteredCount = computed(() => topicTotalCards.value - wordPool.value.length);

                // Computed input class based on state
                const inputClass = computed(() => {
                    if (cardCompleted.value) {
                        return 'border-gray-300 bg-gray-100';
                    }
                    if (lastWasWrong.value) {
                        return 'border-red-400 focus:border-red-500';
                    }
                    return 'border-gray-300 focus:border-blue-500';
                });

                async function fetchCategories() {
                    try {
                        const res = await fetch('/api/categories');
                        categories.value = await res.json();
                    } catch (err) {
                        console.error('Failed to fetch categories:', err);
                    }
                }

                async function fetchTopics() {
                    try {
                        const res = await fetch('/api/topics');
                        availableTopics.value = await res.json();
                    } catch (err) {
                        console.error('Failed to fetch topics:', err);
                    }
                }

                async function loadTopicCards() {
                    try {
                        let url = '/api/cards?limit=1000';
                        if (selectedCategory.value) {
                            url += `&category=${encodeURIComponent(selectedCategory.value)}`;
                        }
                        const res = await fetch(url);
                        const cards = await res.json();
                        allTopicCards.value = cards;
                        // Only include non-mastered cards in the word pool
                        wordPool.value = cards.filter(c => !c.mastered);
                        topicTotalCards.value = cards.length;
                        topicComplete.value = wordPool.value.length === 0 && cards.length > 0;
                        noCards.value = cards.length === 0;

                        if (wordPool.value.length > 0) {
                            pickNextCard();
                        } else {
                            currentCard.value = null;
                            currentCardFull.value = null;
                        }
                    } catch (err) {
                        console.error('Failed to load topic cards:', err);
                        allTopicCards.value = [];
                        wordPool.value = [];
                        topicTotalCards.value = 0;
                    }
                }

                function pickNextCard() {
                    if (wordPool.value.length === 0) {
                        topicComplete.value = true;
                        currentCard.value = null;
                        currentCardFull.value = null;
                        return;
                    }

                    // Pick a random card from the pool
                    const idx = Math.floor(Math.random() * wordPool.value.length);
                    const card = wordPool.value[idx];
                    currentCardFull.value = card;

                    // Build the currentCard shape the UI expects
                    const prompt = mode.value === 'eng_to_viet' ? card.english : card.vietnamese;
                    currentCard.value = {
                        id: card.id,
                        prompt: prompt,
                        mode: mode.value,
                        category: card.category,
                    };

                    // Reset per-card state
                    feedbackMessage.value = '';
                    feedbackType.value = '';
                    expectedAnswer.value = '';
                    userAnswer.value = '';
                    currentHint.value = '';
                    hintLevel.value = 0;
                    hintsUsedThisCard.value = 0;
                    attempts.value = 0;
                    cardCompleted.value = false;
                    lastWasWrong.value = false;
                    noCards.value = false;
                    topicComplete.value = false;

                    // Auto-reveal answer if show answers toggle is on
                    if (showAnswersMode.value) {
                        autoRevealAnswer();
                    }

                    nextTick(() => {
                        answerInput.value?.focus();
                    });
                }

                async function autoRevealAnswer() {
                    if (!currentCard.value) return;
                    hintLevel.value = 3;
                    try {
                        const res = await fetch(`/api/hint?mode=${mode.value}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                card_id: currentCard.value.id,
                                hint_level: 3,
                            }),
                        });
                        const data = await res.json();
                        currentHint.value = data.hint;
                    } catch (err) {
                        console.error('Failed to auto-reveal hint:', err);
                    }
                }

                async function toggleShowAnswers() {
                    showAnswersMode.value = !showAnswersMode.value;
                    if (showAnswersMode.value && currentCard.value && !cardCompleted.value) {
                        await autoRevealAnswer();
                    }
                    if (!showAnswersMode.value && !cardCompleted.value) {
                        currentHint.value = '';
                        hintLevel.value = 0;
                    }
                }

                function addPracticedWord(card, mastered) {
                    const existingIndex = practicedWords.value.findIndex(w => w.id === card.id);
                    if (existingIndex !== -1) {
                        // Update existing entry if now mastered
                        if (mastered && !practicedWords.value[existingIndex].mastered) {
                            practicedWords.value[existingIndex].mastered = true;
                        }
                    } else {
                        practicedWords.value.push({
                            id: card.id,
                            vietnamese: card.vietnamese,
                            english: card.english,
                            mastered: mastered,
                        });
                    }
                }

                async function submitAnswer() {
                    if (!currentCard.value || !userAnswer.value.trim() || cardCompleted.value) return;

                    attempts.value++;

                    try {
                        const res = await fetch('/api/check', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                card_id: currentCard.value.id,
                                user_input: userAnswer.value,
                                record_result: false,
                            }),
                        });
                        const data = await res.json();

                        if (data.correct) {
                            const mastered = hintsUsedThisCard.value <= 2;

                            if (mastered) {
                                // Remove from word pool — word is mastered
                                wordPool.value = wordPool.value.filter(c => c.id !== currentCard.value.id);
                                feedbackMessage.value = 'Correct! Word mastered.';
                                feedbackType.value = 'success';
                            } else {
                                // Keep in pool — used too many hints
                                feedbackMessage.value = 'Correct! But you used too many hints — this word will come back.';
                                feedbackType.value = 'warning';
                            }

                            expectedAnswer.value = data.expected;
                            cardCompleted.value = true;
                            lastWasWrong.value = false;

                            addPracticedWord(currentCardFull.value, mastered);

                            // Record the result on the server
                            await fetch('/api/check', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    card_id: currentCard.value.id,
                                    user_input: userAnswer.value,
                                    record_result: true,
                                    mark_mastered: mastered,
                                }),
                            });
                        } else {
                            feedbackMessage.value = 'Incorrect - Try again!';
                            feedbackType.value = 'error';
                            lastWasWrong.value = true;
                            userAnswer.value = '';

                            answerInput.value?.classList.add('shake');
                            setTimeout(() => {
                                answerInput.value?.classList.remove('shake');
                            }, 500);

                            await nextTick();
                            answerInput.value?.focus();
                        }
                    } catch (err) {
                        console.error('Failed to check answer:', err);
                    }
                }

                async function giveUp() {
                    if (!currentCard.value || cardCompleted.value) return;

                    try {
                        const res = await fetch('/api/give_up', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                card_id: currentCard.value.id,
                            }),
                        });
                        const data = await res.json();

                        feedbackMessage.value = 'Better luck next time! This word will come back.';
                        feedbackType.value = 'warning';
                        expectedAnswer.value = mode.value === 'eng_to_viet' ? data.vietnamese : data.english;
                        cardCompleted.value = true;
                        lastWasWrong.value = false;

                        // Card stays in pool — not mastered
                        addPracticedWord({
                            id: currentCard.value.id,
                            vietnamese: data.vietnamese,
                            english: data.english,
                        }, false);
                    } catch (err) {
                        console.error('Failed to give up:', err);
                    }
                }

                async function getHint() {
                    if (!currentCard.value || hintLevel.value >= 3) return;

                    hintLevel.value++;
                    hintsUsedThisCard.value++;
                    try {
                        const res = await fetch(`/api/hint?mode=${mode.value}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                card_id: currentCard.value.id,
                                hint_level: hintLevel.value,
                            }),
                        });
                        const data = await res.json();
                        currentHint.value = data.hint;
                    } catch (err) {
                        console.error('Failed to get hint:', err);
                    }
                }

                function nextCard() {
                    pickNextCard();
                }

                function setMode(newMode) {
                    mode.value = newMode;
                    resetSessionTracking();
                    loadTopicCards();
                }

                function resetSessionTracking() {
                    practicedWords.value = [];
                    topicComplete.value = false;
                }

                async function onCategoryChange() {
                    resetSessionTracking();
                    await loadTopicCards();
                }

                function restartTopic() {
                    resetSessionTracking();
                    wordPool.value = allTopicCards.value.filter(c => !c.mastered);
                    topicComplete.value = false;
                    if (wordPool.value.length > 0) {
                        pickNextCard();
                    }
                }

                async function resetTopicMastery() {
                    if (!confirm(`Reset mastery for ${selectedCategory.value || 'all topics'}? This will move all words back to the practice pool.`)) {
                        return;
                    }
                    try {
                        const res = await fetch('/api/mastery/reset', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                category: selectedCategory.value || null,
                            }),
                        });
                        if (res.ok) {
                            resetSessionTracking();
                            await loadTopicCards();
                        }
                    } catch (err) {
                        console.error('Failed to reset mastery:', err);
                    }
                }

                async function addCard() {
                    try {
                        const res = await fetch('/api/card', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                vietnamese: newCard.vietnamese,
                                english: newCard.english,
                                category: newCard.category || null,
                                difficulty_level: 1,
                            }),
                        });

                        if (res.ok) {
                            newCard.vietnamese = '';
                            newCard.english = '';
                            newCard.category = '';
                            showAddCard.value = false;
                            fetchCategories();
                            loadTopicCards();
                        }
                    } catch (err) {
                        console.error('Failed to add card:', err);
                    }
                }

                async function loadTopic(filename, clearExisting = false) {
                    loadingTopic.value = filename;
                    topicMessage.value = '';
                    try {
                        const res = await fetch('/api/topics/load', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ filename, clear_existing: clearExisting }),
                        });
                        const data = await res.json();
                        if (res.ok) {
                            topicMessage.value = data.message;
                            topicMessageType.value = 'success';
                            await refreshCategories();
                        } else {
                            topicMessage.value = data.detail || 'Failed to load topic';
                            topicMessageType.value = 'error';
                        }
                    } catch (err) {
                        topicMessage.value = 'Failed to load topic';
                        topicMessageType.value = 'error';
                    } finally {
                        loadingTopic.value = null;
                    }
                }

                async function syncAllTopics() {
                    syncing.value = true;
                    topicMessage.value = '';
                    try {
                        const res = await fetch('/api/topics/sync', { method: 'POST' });
                        const data = await res.json();
                        topicMessage.value = data.message;
                        topicMessageType.value = 'success';
                        await refreshCategories();
                    } catch (err) {
                        topicMessage.value = 'Failed to sync topics';
                        topicMessageType.value = 'error';
                    } finally {
                        syncing.value = false;
                    }
                }

                async function refreshCategories() {
                    await Promise.all([fetchCategories(), fetchTopics()]);
                    await loadTopicCards();
                }

                // Handle Enter key to go to next card when completed
                function handleKeydown(event) {
                    if (event.key === 'Enter' && cardCompleted.value) {
                        event.preventDefault();
                        nextCard();
                    }
                }

                onMounted(async () => {
                    document.addEventListener('keydown', handleKeydown);
                    await fetchCategories();
                    await fetchTopics();
                    await loadTopicCards();
                });

                onUnmounted(() => {
                    document.removeEventListener('keydown', handleKeydown);
                });

                return {
                    mode,
                    currentCard,
                    userAnswer,
                    expectedAnswer,
                    currentHint,
                    hintLevel,
                    showAddCard,
                    noCards,
                    topicTotalCards,
                    masteredCount,
                    wordPool,
                    practicedWords,
                    topicComplete,
                    newCard,
                    answerInput,
                    feedbackMessage,
                    feedbackType,
                    attempts,
                    cardCompleted,
                    inputClass,
                    selectedCategory,
                    categories,
                    availableTopics,
                    showTopicManager,
                    loadingTopic,
                    syncing,
                    topicMessage,
                    topicMessageType,
                    showAnswersMode,
                    submitAnswer,
                    giveUp,
                    getHint,
                    nextCard,
                    setMode,
                    onCategoryChange,
                    restartTopic,
                    resetTopicMastery,
                    addCard,
                    loadTopic,
                    loadTopicCards,
                    syncAllTopics,
                    refreshCategories,
                    toggleShowAnswers,
                };
            },
        }).mount('#app');
    </script>
</body>
</html>
